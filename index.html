<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Редактор изображений — расширенный</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;display:flex;justify-content:center;padding:40px}
    .container{background:#fff;padding:30px;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.1);width:750px}
    h2{margin:0 0 16px;color:#333}
    #dropArea{border:2px dashed #888;border-radius:12px;padding:26px;margin:10px 0;background:#fafafa;cursor:pointer;text-align:center}
    .options{margin:12px 0;text-align:left}
    input,button{padding:8px;border-radius:8px;border:1px solid #ccc;font-size:14px}
    button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
    .format-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:10px}
    .format-card{display:flex;align-items:flex-start;gap:8px;background:#f9fafb;border:2px solid #ddd;padding:10px;border-radius:10px;cursor:pointer}
    .format-card:hover{border-color:#6366f1;background:#eef2ff}
    .preview{display:flex;align-items:center;justify-content:space-between;margin:10px 0;background:#f9fafb;padding:10px;border-radius:8px;position:relative}
    .preview img{width:80px;border-radius:6px;margin-right:10px}
    .tooltip{position:absolute;top:-28px;left:90px;font-size:12px;background:#111;color:white;padding:4px 7px;border-radius:6px;display:none;white-space:nowrap;z-index:20}
    .preview:hover .tooltip{display:block}
    .remove-btn{background:#ef4444;color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
    .rename-panel{margin-top:10px;background:#f1f5f9;padding:12px;border-radius:12px;display:none}
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>

<body>
<div class="container">
  <h2>Редактор изображений</h2>

  <div id="dropArea">Перетащите фото или нажмите</div>
  <input id="fileInput" type="file" accept="image/*" multiple style="display:none">

  <!-- Переименование -->
  <button id="renameToggleBtn" style="margin-top:10px;background:#0ea5e9">
    Переименовать файлы
  </button>

  <div class="rename-panel" id="renamePanel">
    <label><b>Новое базовое имя:</b></label><br>
    <input id="renameInput" type="text" placeholder="например: отпуск" style="margin-top:5px;width:70%">
    <p style="font-size:13px;color:#555;margin-top:5px">
      Итог: <i>imya-1.jpg</i>, <i>imya-2.webp</i>, ...
    </p>
  </div>

  <div class="options">

    <label><input id="resizeCheck" type="checkbox" checked> Изменить разрешение</label><br>
    <div id="resizeOptions" style="margin:8px 0 6px 18px">
      <label>Макс. длинная сторона (px):</label>
      <input id="maxSize" type="number" value="1920" style="width:110px;margin-left:8px">
    </div>

    <label><input id="compressCheck" type="checkbox" checked> Сжать до 1 МБ</label><br>

    <label style="display:block;margin-top:6px">
      <input id="pngToWebpFallback" type="checkbox">
      Если PNG слишком большой — в WebP
    </label>

    <p style="margin-top:10px"><b>Формат конвертации:</b></p>

    <div class="format-options">
      <label class="format-card"><input type="radio" name="format" value="original"><div><b>Оригинал</b><br><small>как есть</small></div></label>
      <label class="format-card"><input type="radio" name="format" value="image/jpeg"><div><b>JPEG</b><br><small>фото</small></div></label>
      <label class="format-card"><input type="radio" name="format" value="image/png"><div><b>PNG</b><br><small>без потерь</small></div></label>
      <label class="format-card"><input type="radio" name="format" value="image/webp" checked><div><b>WebP</b><br><small>минимум веса</small></div></label>
    </div>

  </div>

  <button id="processBtn">Обработать</button>
  <button id="downloadAllBtn" style="display:none;background:#10b981;margin-left:8px">Скачать ZIP</button>

  <progress id="progressBar" value="0" max="100" style="display:none;width:100%;margin-top:12px;height:16px"></progress>

  <div id="output" style="margin-top:12px"></div>
</div>

<script>

/* ------------------------ TRANSLITERATION ---------------------- */

function transliterate(str) {
  const map = {
    'а':'a','б':'b','в':'v','г':'g','д':'d','е':'e','ё':'yo','ж':'zh','з':'z','и':'i',
    'й':'y','к':'k','л':'l','м':'m','н':'n','о':'o','п':'p','р':'r','с':'s','т':'t',
    'у':'u','ф':'f','х':'h','ц':'c','ч':'ch','ш':'sh','щ':'sch','ъ':'','ы':'y',
    'ь':'','э':'e','ю':'yu','я':'ya',
    'А':'A','Б':'B','В':'V','Г':'G','Д':'D','Е':'E','Ё':'Yo','Ж':'Zh','З':'Z','И':'I',
    'Й':'Y','К':'K','Л':'L','М':'M','Н':'N','О':'O','П':'P','Р':'R','С':'S','Т':'T',
    'У':'U','Ф':'F','Х':'H','Ц':'C','Ч':'Ch','Ш':'Sh','Щ':'Sch','Ъ':'','Ы':'Y',
    'Ь':'','Э':'E','Ю':'Yu','Я':'Ya'
  };

  return str
    .split('')
    .map(ch => map[ch] ?? ch)
    .join('')
    .replace(/\s+/g, '-')     // пробелы → "-"
    .replace(/_+/g, '-')      // "_" → "-"
    .replace(/[^a-zA-Z0-9\-]/g, '') // удалить всё лишнее
    .replace(/-+/g, '-')      // "--" → "-"
    .replace(/^-|-$/g, '');   // убрать "-"" по краям
}

/* ------------------------ GLOBALS ------------------------------ */

let selectedFiles = [];
let processedFiles = [];
let renameEnabled = false;

const LIMIT = 1024 * 1024;

const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const output = document.getElementById('output');
const renameToggleBtn = document.getElementById('renameToggleBtn');
const renamePanel = document.getElementById('renamePanel');

/* ------------------------ RENAME TOGGLE ------------------------ */

renameToggleBtn.onclick = () => {
  renameEnabled = !renameEnabled;
  renamePanel.style.display = renameEnabled ? 'block' : 'none';
  renameToggleBtn.style.background = renameEnabled ? "#0284c7" : "#0ea5e9";

  if (renameEnabled) {
    applyRenameIfNeeded();
    showPreview();
  }
};

/* ------------------------ FILE ADD ----------------------------- */

dropArea.onclick = () => fileInput.click();

dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('dragover'); });
dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
dropArea.addEventListener('drop', e => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  selectedFiles = [...selectedFiles, ...e.dataTransfer.files];
  applyRenameIfNeeded();
  showPreview();
});

fileInput.onchange = () => {
  selectedFiles = [...selectedFiles, ...fileInput.files];
  applyRenameIfNeeded();
  showPreview();
};

/* ------------------------ MASS RENAME --------------------------- */

function applyRenameIfNeeded() {
  if (!renameEnabled) return;

  let base = document.getElementById("renameInput").value.trim();
  if (!base) return;

  base = transliterate(base);

  selectedFiles = selectedFiles.map((file, index) => {
    const ext = file.name.split('.').pop();
    const newName = `${base}-${index+1}.${ext}`;
    return new File([file], newName, { type: file.type });
  });
}

/* ------------------------ PREVIEW ------------------------------- */

function showPreview() {
  output.innerHTML = "";

  selectedFiles.forEach((file, index) => {
    const url = URL.createObjectURL(file);
    const div = document.createElement("div");
    div.className = "preview";

    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const tooltip = document.createElement("div");
        tooltip.className = "tooltip";
        tooltip.textContent =
          `${img.width}×${img.height}px — ${(file.size/1024).toFixed(1)} КБ — ${file.type}`;
        div.appendChild(tooltip);
      };
    };
    reader.readAsDataURL(file);

    div.innerHTML += `
      <div style="display:flex;align-items:center">
        <img src="${url}">
        <span>${file.name}</span>
      </div>
      <button class="remove-btn" onclick="removeFile(${index})">Удалить</button>
    `;

    output.appendChild(div);
  });
}

function removeFile(i){
  selectedFiles.splice(i,1);
  applyRenameIfNeeded();
  showPreview();
}
window.removeFile = removeFile;

/* ------------------------ CANVAS TO BLOB ------------------------ */

function blobFromCanvas(canvas, mime, q){
  return new Promise(res => canvas.toBlob(res, mime, q));
}

/* ------------------------ PROCESSING ---------------------------- */

document.getElementById('processBtn').onclick = async () => {

  if (!selectedFiles.length) return alert("Добавьте файлы!");

  const resizeEnabled = document.getElementById("resizeCheck").checked;
  const compressEnabled = document.getElementById("compressCheck").checked;
  const pngToWebpFallback = document.getElementById("pngToWebpFallback").checked;
  const targetRad = document.querySelector('input[name="format"]:checked').value;
  const maxSide = parseInt(document.getElementById("maxSize").value) || 1920;

  output.innerHTML = "";
  processedFiles = [];

  const progressBar = document.getElementById('progressBar');
  progressBar.style.display = "block";
  progressBar.value = 0;

  for (let i = 0; i < selectedFiles.length; i++) {

    const file = selectedFiles[i];
    const img = new Image();
    img.src = URL.createObjectURL(file);
    await img.decode();

    let w = img.width, h = img.height;

    if (resizeEnabled) {
      if (w > h && w > maxSide) {
        h = Math.round(h * (maxSide / w)); w = maxSide;
      } else if (h > w && h > maxSide) {
        w = Math.round(w * (maxSide / h)); h = maxSide;
      }
    }

    let canvas = document.createElement('canvas');
    let ctx = canvas.getContext('2d');
    canvas.width = w; canvas.height = h;
    ctx.drawImage(img, 0, 0, w, h);

    let target = (targetRad === "original") ? file.type : targetRad;
    let blob;

    if (target === "image/jpeg" || target === "image/webp") {
      let q = 0.9;
      do {
        blob = await blobFromCanvas(canvas, target, q);
        q -= 0.05;
      } while (compressEnabled && blob.size > LIMIT && q > 0.1);
    }

    else if (target === "image/png") {
      blob = await blobFromCanvas(canvas, "image/png");
      if (compressEnabled && blob.size > LIMIT) {
        let cw = w, ch = h;
        const min = 200;
        while (blob.size > LIMIT && cw > min && ch > min) {
          cw = Math.round(cw * 0.9);
          ch = Math.round(ch * 0.9);
          let tmp = document.createElement("canvas");
          tmp.width = cw; tmp.height = ch;
          tmp.getContext("2d").drawImage(img, 0, 0, cw, ch);
          blob = await blobFromCanvas(tmp, "image/png");
          canvas = tmp;
        }
      }
      if (compressEnabled && blob.size > LIMIT && pngToWebpFallback) {
        target = "image/webp";
        let q = 0.9;
        let tmp;
        do {
          tmp = await blobFromCanvas(canvas, "image/webp", q);
          q -= 0.05;
        } while (tmp.size > LIMIT && q > 0.1);
        blob = tmp;
      }
    }

    else {
      blob = await blobFromCanvas(canvas, target);
    }

    /* ------------------------- FINAL NAME ------------------------- */

    let base = renameEnabled ? document.getElementById("renameInput").value.trim() : null;
    let outName;

    if (renameEnabled && base) {
      base = transliterate(base);
      const ext = target.split("/")[1];
      outName = `${base}-${i+1}.${ext}`;
    } else {
      const ext = target.split("/")[1];
      outName = file.name.replace(/\.[^.]+$/, "") + "." + ext;
    }

    processedFiles.push({ name: outName, blob });

    /* Preview processed */
    const url = URL.createObjectURL(blob);
    const div = document.createElement('div');
    div.className = 'preview';

    const newImg = new Image();
    newImg.src = url;
    await newImg.decode();

    const tooltip = document.createElement('div');
    tooltip.className = 'tooltip';
    tooltip.textContent =
      `${newImg.width}×${newImg.height}px — ${(blob.size/1024).toFixed(1)} КБ — ${target}`;
    div.appendChild(tooltip);

    div.innerHTML += `
      <div style="display:flex;align-items:center">
        <img src="${url}">
        <span>${outName}</span>
      </div>
      <a href="${url}" download="${outName}">Скачать</a>
    `;
    output.appendChild(div);

    progressBar.value = Math.round(((i+1)/selectedFiles.length) * 100);
  }

  progressBar.style.display = "none";

  if (processedFiles.length > 1)
    document.getElementById('downloadAllBtn').style.display = "inline-block";
};

/* ------------------------ ZIP DOWNLOAD -------------------------- */

document.getElementById("downloadAllBtn").onclick = async () => {
  const zip = new JSZip();
  processedFiles.forEach(f => zip.file(f.name, f.blob));
  const content = await zip.generateAsync({type:'blob'});
  saveAs(content, "images.zip");
};

</script>

</body>
</html>
